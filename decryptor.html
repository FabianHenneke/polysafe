<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>PolySafe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <label for="password">Password:</label>
    <input type="password" id="password">
    <input type="button" id="decrypt" value="Decrypt file">
    <script id="data" type="application/json">
        {"salt":[255,64,43,211,4,88,91,37,24,33,41,82,255,249,226,146],"iv":[61,131,249,232,63,7,218,245,31,64,16,48,231,106,16,233],"encrypted":"5zJ7IDDz11sUzry6pBIX5XKDrWL986AO/6Ay3ikz+z7ozkPOR59LqvNeB0TFz/AB3TaM"}
    </script>
    <script>
        function base64ToArray(base64) {
            return new Uint8Array(atob(base64).split('').map(function (c) {
                return c.charCodeAt(0);
            }));
        }

        function deriveKey(password, salt) {
            var passwordBytes = new TextEncoder('utf-8').encode(password);

            return window.crypto.subtle.importKey(
                'raw',
                passwordBytes, {
                    name: 'PBKDF2'
                },
                false,
                ['deriveKey']
            ).then(function (key) {
                return window.crypto.subtle.deriveKey({
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 200000,
                        hash: {
                            name: 'SHA-512'
                        }
                    },
                    key, {
                        name: 'AES-GCM',
                        length: 256
                    },
                    false,
                    ['decrypt']
                )
            });
        }

        function decrypt(key, iv, bytes) {
            return window.crypto.subtle.decrypt({
                name: 'AES-GCM',
                length: 256,
                iv: iv
            }, key, bytes);
        }

        function extractDecryptedFile(buffer) {
            var bytes = new Uint8Array(buffer);
            var slash_pos = bytes.indexOf('/'.charCodeAt(0));
            if (slash_pos == -1) {
                throw 'Decrypted data is corrupted';
            } else {
                var name = new TextDecoder('utf-8').decode(bytes.slice(0, slash_pos));
                var content = bytes.slice(slash_pos + 1);
                return {
                    name: name,
                    content: content
                };
            }
        }

        function download(file) {
            var a = document.createElement('a');
            a.style = 'display: none';
            document.body.appendChild(a);
            var blob = new Blob([file.content], {
                type: 'application/octet-stream'
            });
            var url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = file.name;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function runDecrypt() {
            if (!window.crypto) {
                alert(
                    'Full support for the WebCrypto API is needed for decryption. Please use one of the following browsers: Chrome 37+, Firefox 34+, Safari 7+, Opera 24+'
                )
            }
            document.getElementById('decrypt').disabled = true;
            document.getElementById('decrypt').value = 'Decrypting...';

            setTimeout(function () {
                var data = JSON.parse(document.getElementById('data').textContent);
                var salt = new Uint8Array(data.salt);
                var iv = new Uint8Array(data.iv);
                var encrypted = base64ToArray(data.encrypted);

                var password = document.getElementById('password').value;
                deriveKey(password, salt)
                    .then(function (key) {
                        return decrypt(key, iv, encrypted);
                    })
                    .catch(function () {
                        throw 'Wrong password or corrupted file.';
                    })
                    .then(extractDecryptedFile)
                    .then(download)
                    .catch(function (e) {
                        alert('Error during decryption: ' + e);
                    })
                    .then(function () {
                        document.getElementById('decrypt').disabled = false;
                        document.getElementById('decrypt').value = 'Decrypt file';
                    });
            }, 0);
        }

        document.getElementById('decrypt').addEventListener('click', runDecrypt);
    </script>
</body>

</html>
