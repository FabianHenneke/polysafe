<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Trusty Safe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <input type="password" id="txt_password">
    <input type="button" id="btn_decrypt" value="Decrypt">
    <script>
        const PBKDF2_SALT = new Uint8Array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]);
        const AES_GCM_IV = new Uint8Array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]);
        const FILENAME = 'example.txt';
        const ENCRYPTED_BYTES = new Uint8Array([209, 6, 163, 99, 209, 154, 220, 158, 168, 68, 235, 224, 89, 113, 103,
            112, 74, 63, 46, 64, 95, 151, 154, 152, 85, 3, 211, 88, 170, 175, 83, 107, 197, 255, 167, 43, 17,
            35, 123
        ]);
    </script>
    <script>
        function deriveKey(password, salt) {
            const passwordBytes = new TextEncoder('utf-8').encode(password);

            return window.crypto.subtle.importKey(
                'raw',
                passwordBytes, {
                    name: 'PBKDF2'
                },
                false,
                ['deriveKey']
            ).then(function (key) {
                return window.crypto.subtle.deriveKey({
                        name: "PBKDF2",
                        salt,
                        iterations: 200000,
                        hash: {
                            name: "SHA-512"
                        }
                    },
                    key, {
                        name: "AES-GCM",
                        length: 256
                    },
                    false,
                    ['decrypt']
                )
            });
        }

        function decrypt(key, iv, bytes) {
            return window.crypto.subtle.decrypt({
                name: "AES-GCM",
                length: 256,
                iv
            }, key, bytes)
        }

        function extractDecryptedContent(buffer) {
            const bytes = new Uint8Array(buffer);
            const slash_pos = bytes.indexOf('/');
            if (slash_pos == -1) {
                throw "Decrypted data is corrupted";
            } else {
                const filename = new TextDecoder('utf-8').decode(bytes.slice(0, slash_pos));
                const content = bytes.slice(slash_pos + 1);
                return (filename, content);
            }
        }

        function runDecrypt() {
            if (!window.crypto) {
                alert(
                    'Full support for the WebCrypto API is needed for decryption. Please use one of the following browsers: Chrome 37+, Firefox 34+, Safari 7+, Opera 24+'
                )
            }
            const password = document.getElementById('txt_password').value;
            deriveKey(password, PBKDF2_SALT)
                .then(key => decrypt(key, AES_GCM_IV, ENCRYPTED_BYTES))
                .catch(e => console.log(e))
                .then(extractDecryptedContent)
                .then((filename, content) => download(filename, buffer));
        }

        document.getElementById('btn_decrypt').addEventListener('click', runDecrypt);
    </script>
</body>

</html>
